<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8" />
<title>Pauls Canvas Workshop</title>
	<style>
	* { padding: 0; margin: 0; }
	canvas { background: #eee; display: block; margin: 0 auto; }
	</style>
</head>
<body>
<canvas id="myCanvas" width="480" height="320"></canvas>

<script>
var canvas = document.getElementById("myCanvas");
var ctx = canvas.getContext("2d");
var img = new Image();
img.src = "Images/Sprites2.png";
var dataTick;
var awayTick;
var hungerLevel;
var dataHunger;
var graph_height = 16;
var inadayTick = 86400; //or inadayTick*1000 = milliseconds in a day
var tuesdayInMiliseconds;
var nowTick = Date.now();
var feedButtonX = 8; // Used for x of both feed bar and surrounding box/button
var feedButtonY = 6; // Used for Y of both feed bar and surrounding box/button
var feedButtonW = 34; // Used for width of both feed bar and surrounding box/button
var feedButtonH = graph_height + 4; // Used for height of both feed bar and surrounding box/button
var my_gradient = ctx.createLinearGradient((feedButtonX + 2), (feedButtonY), (feedButtonX + 6), (feedButtonY + 18));

//Load the data if localStorage enabled
function LoadData() {
if(!!window.localStorage){
dataTick = JSON.parse(localStorage.getItem("savedTick"));
dataHunger = JSON.parse(localStorage.getItem("savedHunger"));
tuesdayInMiliseconds = JSON.parse(localStorage.getItem("savedTuesday"));
awayTick = Math.round((nowTick - dataTick) / 1000); // This works out the difference between NOW time and retrived tick counter in seconds
hungerLevel = dataHunger - (-Math.abs(awayTick / inadayTick) * graph_height); //This works out difference between how long you've been gone and DAY seconds
  }
else{
    alert("No Web Storage without HTTP");
  }
}

function updateTick() {
 nowTick = Date.now();
}

function updateHunger() {
if (parseInt(hungerLevel) < 16){
hungerLevel = (hungerLevel + graph_height / (inadayTick*1000));
}
else {
	hungerLevel = 16;
    }
}

//This checks to see if today is Tuesday. If it isn't, work out when Tuesday is. If it is, there should be an else on the if to make rock happy
function getTuesday(){
var d=new Date();
d.setDate((2-d.getDay()+7)%7+d.getDate());
var tuesday = d.toDateString();
tuesdayInMiliseconds = new Date(tuesday).getTime();
}

//var dayOfTheWeek = (d.getDay()); this line is only left in because it works out what day it is and Id have to code it again if needed


//Function to save the data
function SaveData() {
localStorage.setItem("savedTick", JSON.stringify(nowTick));
localStorage.setItem("savedHunger", JSON.stringify(hungerLevel));
localStorage.setItem("savedTuesday", JSON.stringify(tuesdayInMiliseconds));
}

//Event listener for feed button press
canvas.addEventListener("click", function(e) {
 var rect = canvas.getBoundingClientRect();
 var x = Math.floor(e.clientX - rect.left);
 var y = Math.floor(e.clientY - rect.top);
 //alert("Mouse Position x: " + x + " y: " + y);
 //alert("Mouse Click");
 if (
  hungerLevel > ((graph_height / 3) * 2) &&
  x >= feedButtonX &&
  x < feedButtonX + feedButtonW &&
  y >= feedButtonY &&
  y < feedButtonY + feedButtonH
 ) {
  alert("Feed ME!");
  hungerLevel = 0;
 }
});

function draw() {
 ctx.font = "8px Arial";
 ctx.fillStyle = "#0095DD";
 ctx.clearRect(0, 0, canvas.width, canvas.height);
 ctx.fillText("Seconds Away: " + awayTick, 380, 10);
 ctx.fillText("Hunger: " + parseInt(hungerLevel), 380, 20);
 ctx.fillText("Tick: " + nowTick, 380, 30);

 ctx.drawImage(img, 0, 0, 36, 22, 7, 5, 36, 22); //Feed grab_x, grab_y, grab_width_x, grab_width_y, position_x, position_y, scale_x, scale_y
 ctx.drawImage(img, 0, 23, 38, 22, 48, 6, 38, 22); //Rock grab_x, grab_y, grab_width_x, grab_width_y, position_x, position_y, scale_x, scale_y

 //Draw nourishment graph - Feed once every 24 hours
 //x, y start of gradient, then x, y end of gradient
 my_gradient.addColorStop(0, 'rgba(92, 182, 88, 0.9)');
 my_gradient.addColorStop(0.66, 'rgba(255, 173, 56, 0.9)');
 my_gradient.addColorStop(1, 'rgba(244, 0, 5, 0.9)');
 ctx.fillStyle = my_gradient;
 ctx.fillRect((feedButtonX + 2), (feedButtonY + 18), 4, (-Math.abs(graph_height) + hungerLevel)); //x, y co-ords of box then width, height

requestAnimationFrame(draw);
updateTick();
updateHunger();

window.onunload = function() {
    SaveData();
    };
}

LoadData();
getTuesday();
draw();

</script>
</body>
</html>
