<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8" />
<title>Pauls Canvas Workshop</title>
	<style>* { padding: 0; margin: 0; } canvas { background: #eee; display: block; margin: 0 auto; } </style>
</head>
<body>
<canvas id="myCanvas" width="480" height="320"></canvas>

<script>
//localStorage.removeItem("savedTick");
//localStorage.removeItem("savedAttention");
//localStorage.removeItem("savedTuesday");
//localStorage.removeItem("beenTold");
var canvas = document.getElementById("myCanvas");
var ctx = canvas.getContext("2d");
var img = new Image();
img.src = "Images/Sprites2.png";
var dataTick;
var awayTick;
var attentionLevel = 0;
var dataAttention;
var graph_height = 16;
var tuesdayInMiliseconds;
var beenTold;
var nowTick = Date.now();
var ticks = {
    day: 86400000,
    week: 604800000,
    overAWeek: 691200000
};
var feedButton = {
    x: 8,
    y: 6,
    w: 34,
	h: 20
};
var up = {
    x: 53,
    y: 11,
    t: 1 //originally 0.4
};
var attentionGradient = ctx.createLinearGradient(10, 6, 14, 24);
var clicked = "nope";
var mousecount = 0;
var MissedItBy;

//Load the data
function LoadData() {
    if (!!window.localStorage) {
        dataTick = JSON.parse(localStorage.getItem("savedTick"));
        dataAttention = JSON.parse(localStorage.getItem("savedAttention"));
        tuesdayInMiliseconds = JSON.parse(localStorage.getItem("savedTuesday"));
        beenTold = localStorage.getItem("beenTold"); // With this line removed, the whole thing works well... because it's not loading NOTHING!
        awayTick = Math.round((nowTick - dataTick) / 1000);
        attentionLevel = dataAttention - (-Math.abs(awayTick / (ticks.day / 1000)) * graph_height);
        attentionLevel = 13;
    } else {
        alert("No Web Storage without HTTP");
    }
}

// I know what's wrong with this bit.
// The variable beenTold gets set depending on the value of beenTold!
// Therefore the line WAY up there that loads beenTold loads nothing.
// Checks the value of beenTold, which is nothing, so beenTold doesn't change!!
// While experiemnting, I set a value for beenTold, which will make the program run now...
// But really, it's very wrong.

//Work out forfeits.
function getIntervals() {
    var d = new Date();
    var interval;
    var dayOfTheWeek = (d.getDay());
    //Only do this bit if there's actually a value to Tuesday's date
    if (tuesdayInMiliseconds === undefined || tuesdayInMiliseconds === "" || tuesdayInMiliseconds === null) {
        beenTold = "nope";
		alert("First time, huh?");
    } else {
        if (dayOfTheWeek == 3 && (nowTick - dataTick) > ticks.overAWeek) {
            alert("You missed last Tuesday's update");
        } //If it's Wednesday and time away is more than a just over a week works perfectly
        else { //This works if its a Tuesday, but when it's a Tuesday in two months time, for example, it still loves ya!
            if (dayOfTheWeek == 2) { //Or else, it might be Tuesday. In which case, say how great the visitor is 
                beenTold = "nope";
                alert("YEAH, proper FAN!"); //Should turn on hourly star rewards, proper fan!
            }

            if (beenTold == "nope") {
                if (dayOfTheWeek > 2 && dayOfTheWeek <= 6) { //Or else, it might NOT Tueday, say how long ago Tuesday was.
                    MissedItBy = dayOfTheWeek - 2;
                }

                if (dayOfTheWeek < 2) { //Still might NOT Tueday, say how long ago Tuesday was.
                    MissedItBy = dayOfTheWeek + 5;
                }

                beenTold = "yep";
                alert("The update was " + MissedItBy + " days ago");
            }
        }
    }

    if (beenTold == "nope") {
        interval = 9;
    } else {
        interval = 2;
    }

    d.setDate((interval - d.getDay() + (interval + 5)) % (interval + 5) + d.getDate());
    var tuesday = d.toDateString();
    tuesdayInMiliseconds = new Date(tuesday).getTime();
    alert("Don't forget to come back " + tuesday + " for another update!");
}

function updateTick() {
    nowTick = Date.now();
}

function updateAttention() {
    if (parseInt(attentionLevel) < 16) {
        attentionLevel = (attentionLevel + graph_height / (ticks.day));
    } else {
        attentionLevel = 16;
    }
}

window.onunload = function () {
    localStorage.setItem("savedTick", JSON.stringify(nowTick));
    localStorage.setItem("savedAttention", JSON.stringify(attentionLevel));
    localStorage.setItem("savedTuesday", JSON.stringify(tuesdayInMiliseconds));
    localStorage.setItem("beenTold", beenTold);
};

function clicker() {
    if (clicked === "yep") {
        setTimeout(function () {
            ++mousecount;
            clicked = "nope";
            //This would go to spangle add number of clicks. Or might have another pause to allow for click stop
            mousecount = 0;
        }, 3000);
    }
}

//Event listener for feed button press
canvas.addEventListener("click", function (e) {
    var rect = canvas.getBoundingClientRect();
    var x = Math.floor(e.clientX - rect.left);
    var y = Math.floor(e.clientY - rect.top);
    //alert("Mouse Position x: " + x + " y: " + y);
    if (
        //attentionLevel > 10.667 &&
        x >= feedButton.x &&
        x < feedButton.x + feedButton.w &&
        y >= feedButton.y &&
        y < feedButton.y + feedButton.h
    ) {
        if (clicked === "yep") {
            ++mousecount;
        }

        if (clicked === "nope") {
            clicked = "yep";
            clicker();
        }
    }
});

function draw() {
    ctx.font = "8px Arial";
    ctx.fillStyle = "#0095DD";
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    ctx.fillText("Seconds Away: " + awayTick, 380, 10);
    ctx.fillText("Tick: " + nowTick, 380, 20);
    ctx.drawImage(img, 0, 0, 36, 22, 7, 5, 36, 22);
    ctx.drawImage(img, 0, 23, 38, 22, 48, 6, 38, 22);
    ctx.save();
    ctx.globalAlpha = up.t;
    ctx.drawImage(img, 0, 46, 10, 10, up.x, up.y, 10, 10);
    ctx.restore();
    ctx.fillStyle = 'rgba(92,182,88,0.3)';
    ctx.fillRect(feedButton.x, feedButton.y, feedButton.w, 22);
    attentionGradient.addColorStop(0, 'rgba(92, 182, 88, 0.8)');
    attentionGradient.addColorStop(0.66, 'rgba(255, 173, 56, 0.8)');
    attentionGradient.addColorStop(1, 'rgba(244, 0, 5, 0.8)');
    ctx.fillStyle = attentionGradient;
    ctx.fillRect(10, 24, 4, (-Math.abs(graph_height) + attentionLevel));

    requestAnimationFrame(draw);
    updateTick();
    updateAttention();
}

LoadData();
getIntervals();
draw();

</script>
</body>
</html>